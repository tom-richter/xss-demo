<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My super secure blog</title>
  </head>
  <body>
    <h1 id="welcome">Welcome to my super secure blog!</h1>
    <button id="logoutButton" onclick="logout()">Logout</button>

    <div id="loginFormWrapper">
      <h2>Login</h2>
      <form id="loginForm">
        <p>
          <label for="username">Username:</label>
          <input id="username" type="text" name="username" />
        </p>
        <p>
          <label for="password">Password:</label>
          <input id="password" type="password" name="password" />
        </p>
        <input type="submit" value="Login" />
      </form>
    </div>

    <h2>Posts</h2>
    <main id="main"></main>

    <div id="postFormWrapper">
      <h2>Create New Post</h2>
      <form id="postForm">
        <p>
          <label for="title">Title:</label>
          <input id="title" type="text" name="title" />
        </p>
        <p>
          <label for="description">Description:</label>
        </p>
        <textarea
          id="description"
          name="description"
          rows="4"
          cols="50"
        ></textarea
        ><br />
        <input type="submit" value="Create Post" />
      </form>
    </div>

    <script>
      let main = document.getElementById('main')
      fetch('/api/posts')
        .then((r) => r.json())
        .then(
          (posts) =>
            (main.innerHTML = posts
              .map(
                (post) =>
                  `<h3>${post.title}</h3><p>by ${post.user_name}</p><p>${post.description}</p><hr>`
              )
              .join(''))
        )

      fetch('/api/profile', {
        headers: {
          Authorization: localStorage.getItem('accessToken'),
          'Content-Type': 'application/json',
        },
      })
        .then((r) => r.json())
        .then((user) => {
          document.getElementById(
            'welcome'
          ).innerHTML = `Welcome to my super secure blog, ${user.name}!`
          document.getElementById('loginFormWrapper').style.display = 'none'
        })
        .catch((e) => {
          document.getElementById('postFormWrapper').style.display = 'none'
          document.getElementById('logoutButton').style.display = 'none'
        })

      window.addEventListener('load', function () {
        function createPost(postForm) {
          const formData = Array.from(new FormData(postForm))
          const post = {
            title: formData[0][1],
            description: formData[1][1],
          }
          console.log(post)
          fetch('/api/posts', {
            method: 'POST',
            headers: {
              Authorization: localStorage.getItem('accessToken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(post),
          }).then((r) => {
            postForm.reset()
            location.reload()
          })
        }
        function loginUser(loginForm) {
          const formData = Array.from(new FormData(loginForm))
          const user = {
            username: formData[0][1],
            password: formData[1][1],
          }
          fetch('/api/login', {
            method: 'POST',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(user),
          })
            .then((r) => r.json())
            .then((r) => {
              localStorage.setItem('accessToken', r.accessToken)
              loginForm.reset()
              location.reload()
            })
        }

        const postForm = document.getElementById('postForm')

        postForm.addEventListener('submit', function (event) {
          event.preventDefault()
          createPost(postForm)
        })

        const loginForm = document.getElementById('loginForm')

        loginForm.addEventListener('submit', function (event) {
          event.preventDefault()
          loginUser(loginForm)
        })
      })

      function logout() {
        localStorage.clear()
        location.reload()
      }
    </script>
  </body>
</html>

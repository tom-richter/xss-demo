<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1 id="welcome">Welcome to my super secure blog!</h1>

    <div id="loginFormWrapper">
      <h2>Login</h2>
      <form id="loginForm" method="POST">
        <input type="text" name="username" />
        <input type="password" name="password" />
        <input type="submit" />
      </form>
    </div>

    <main id="main"></main>

    <div id="postFormWrapper">
      <h2>New Post</h2>
      <form id="postForm" method="POST">
        <input type="text" name="title" />
        <input type="text" name="description" />
        <input type="submit" />
      </form>
    </div>

    <script>
      let main = document.getElementById('main')
      fetch('/api/posts')
        .then((r) => r.json())
        .then(
          (posts) =>
            (main.innerHTML = posts
              .map(
                (post) =>
                  `<h2>${post.title}</h2><p>by ${post.user_name}</p><p>${post.description}</p>`
              )
              .join(''))
        )
      if (localStorage.getItem('accessToken')) {
        fetch('/api/profile', {
          headers: {
            Authorization: localStorage.getItem('accessToken'),
            'Content-Type': 'application/json',
          },
        })
          .then((r) => r.json())
          .then((user) => {
            document.getElementById(
              'welcome'
            ).innerHTML = `Welcome to my super secure blog, ${user.name}!`
            document.getElementById('loginFormWrapper').style.display = 'none'
          })
          .catch((e) => {
            document.getElementById('postFormWrapper').style.display = 'none'
          })
      } else {
        document.getElementById('postFormWrapper').style.display = 'none'
      }

      window.addEventListener('load', function () {
        function createPost(postForm) {
          const formData = Array.from(new FormData(postForm))
          const post = {
            title: formData[0][1],
            description: formData[1][1],
          }
          console.log(post)
          fetch('/api/posts', {
            method: 'POST',
            headers: {
              Authorization: localStorage.getItem('accessToken'),
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(post),
          }).then((r) => console.log(r))
        }
        function loginUser(loginForm) {
          const formData = Array.from(new FormData(loginForm))
          const user = {
            username: formData[0][1],
            password: formData[1][1],
          }
          fetch('/api/login', {
            method: 'POST',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(user),
          })
            .then((r) => r.json())
            .then((r) => {
              localStorage.setItem('accessToken', r.accessToken)
              location.reload()
            })
        }

        const postForm = document.getElementById('postForm')

        postForm.addEventListener('submit', function (event) {
          event.preventDefault()
          createPost(postForm)
        })

        const loginForm = document.getElementById('loginForm')

        loginForm.addEventListener('submit', function (event) {
          event.preventDefault()
          loginUser(loginForm)
        })
      })
    </script>
  </body>
</html>
